<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Solar System Explorer</title>
    <meta name="description" content="Interactive 3D solar system visualisation with real orbital mechanics">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: white;
            user-select: none;
        }
        
        #canvas {
            display: block;
            cursor: grab;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        .panel {
            position: absolute;
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid rgba(60, 60, 80, 0.5);
            border-radius: 8px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.5;
            z-index: 100;
            backdrop-filter: blur(8px);
        }
        
        .hud {
            top: 20px;
            left: 20px;
            min-width: 260px;
        }
        
        .controls {
            top: 20px;
            right: 20px;
            max-width: 220px;
        }
        
        .planet-info {
            bottom: 20px;
            left: 20px;
            max-width: 350px;
            display: none;
        }
        
        .welcome {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 500px;
        }
        
        .title {
            color: #a0a0ff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .accent { 
            color: #8080ff;
            font-weight: 500;
        }
        
        .highlight { 
            color: #ffcc80;
            font-weight: 500;
        }
        
        .planet-name {
            color: #ffcc80;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        button {
            background: rgba(80, 80, 120, 0.8);
            border: 1px solid rgba(120, 120, 160, 0.6);
            color: white;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: rgba(100, 100, 140, 0.9);
            border-color: rgba(140, 140, 180, 0.8);
        }
        
        button.active {
            background: rgba(120, 120, 160, 0.9);
            border-color: rgba(160, 160, 200, 0.8);
        }
        
        .section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(60, 60, 80, 0.5);
        }
        
        .section-title {
            color: #8080ff;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status.running {
            background: rgba(80, 200, 80, 0.2);
            color: #80ff80;
        }
        
        .status.paused {
            background: rgba(200, 80, 80, 0.2);
            color: #ff8080;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }
        
        .info-item {
            background: rgba(40, 40, 60, 0.6);
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(128, 128, 255, 0.3);
            border-top: 3px solid #8080ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .view-mode {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 40, 60, 0.9);
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(80, 80, 120, 0.5);
        }
        
        @media (max-width: 768px) {
            .panel {
                font-size: 11px;
                padding: 12px;
                max-width: calc(100vw - 40px);
            }
            
            .controls {
                top: auto;
                bottom: 20px;
                right: 20px;
                left: auto;
            }
            
            button {
                padding: 6px 8px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="accent">Loading Solar System...</div>
    </div>
    
    <div class="view-mode" id="viewMode" style="display: none;">
        3D Perspective View
    </div>
    
    <canvas id="canvas"></canvas>
    
    <div class="panel welcome" id="welcome">
        <div class="title">Solar System Explorer</div>
        <p>Interactive visualisation with real orbital mechanics</p>
        <br>
        <p><strong>Controls:</strong></p>
        <p>• Drag to rotate • Scroll to zoom • Click planets for info</p> 
        <p>• Toggle between 3D and 2D map views</p>
        <br>
        <button onclick="hideWelcome()" style="font-size: 13px; padding: 12px 20px;">
            Start Exploring
        </button>
    </div>
    
    <div class="panel hud" id="hud" style="display: none;">
        <div class="title">Solar System Explorer</div>
        <div id="dateDisplay">Date: Loading...</div>
        <div id="cameraInfo">Camera: 0° tilt, 0° rotation</div>
        <div id="zoomInfo">Distance: 20.0 AU</div>
        <div><span class="status running" id="status">RUNNING</span></div>
        <div id="selectedInfo"></div>
        
        <div class="section">
            <div class="section-title">Time Controls</div>
            <button onclick="timeStep(-365)">← Year</button>
            <button onclick="timeStep(-30)">← Month</button>
            <button onclick="timeStep(-1)">← Day</button>
            <br>
            <button onclick="togglePause()" id="pauseBtn">Pause</button>
            <button onclick="resetToToday()">Today</button>
            <br>
            <button onclick="timeStep(1)">Day →</button>
            <button onclick="timeStep(30)">Month →</button>
            <button onclick="timeStep(365)">Year →</button>
        </div>
        
        <div class="section">
            <div class="section-title">Quick Select</div>
            <button onclick="selectPlanet('Mercury')" class="planet-btn" data-planet="Mercury">Mercury</button>
            <button onclick="selectPlanet('Venus')" class="planet-btn" data-planet="Venus">Venus</button>
            <button onclick="selectPlanet('Earth')" class="planet-btn" data-planet="Earth">Earth</button>
            <button onclick="selectPlanet('Mars')" class="planet-btn" data-planet="Mars">Mars</button>
            <br>
            <button onclick="selectPlanet('Jupiter')" class="planet-btn" data-planet="Jupiter">Jupiter</button>
            <button onclick="selectPlanet('Saturn')" class="planet-btn" data-planet="Saturn">Saturn</button>
            <button onclick="selectPlanet('Uranus')" class="planet-btn" data-planet="Uranus">Uranus</button>
            <button onclick="selectPlanet('Neptune')" class="planet-btn" data-planet="Neptune">Neptune</button>
        </div>
    </div>
    
    <div class="panel controls" id="controls" style="display: none;">
        <div class="section-title">Controls</div>
        <div style="margin-bottom: 12px;">
            <div>Mouse Drag: Rotate view</div>
            <div>Mouse Scroll: Zoom in/out</div>
            <div>Click Planet: Select info</div>
            <div>Space: Pause/Resume</div>
            <div>R: Reset camera</div>
            <div>V: Toggle view mode</div>
            <div>1-8: Quick planet select</div>
        </div>
        
        <div class="section">
            <div class="section-title">View Mode</div>
            <button onclick="toggleViewMode()" id="viewModeBtn">Switch to 2D Map</button>
            <button onclick="toggleTrails()" id="trailsBtn">Hide Trails</button>
        </div>
        
        <div class="section">
            <div class="section-title">Zoom Presets</div>
            <button onclick="setZoomPreset('close')">Close</button>
            <button onclick="setZoomPreset('inner')">Inner</button>
            <button onclick="setZoomPreset('outer')">All</button>
            <button onclick="setZoomPreset('system')">System</button>
        </div>
        
        <div class="section">
            <button onclick="resetCamera()">Reset View</button>
            <button onclick="toggleHelp()">Toggle Help</button>
        </div>
    </div>
    
    <div class="panel planet-info" id="planetInfo">
        <div id="planetDetails"></div>
    </div>

    <script>
        const J2000_EPOCH = new Date('2000-01-01T12:00:00Z');
        
        const PLANETS = {
            "Mercury": {
                a: 0.387098, e: 0.205630, i: 7.0049,
                Omega: 48.331, omega: 29.124, M0: 174.796, 
                period: 87.969,
                radius: 5, color: [169, 169, 169], 
                mass_earth: 0.055, gravity: 3.7, temp_avg: 167,
                day_hours: 1407.6, moons: 0,
                fact: "One day on Mercury equals 176 Earth days"
            },
            "Venus": {
                a: 0.723332, e: 0.006772, i: 3.3947,
                Omega: 76.680, omega: 54.884, M0: 50.115,
                period: 224.701,
                radius: 7, color: [255, 198, 73], 
                mass_earth: 0.815, gravity: 8.87, temp_avg: 464,
                day_hours: -5832.5, moons: 0, atmosphere: true,
                fact: "Venus rotates backwards and its day is longer than its year"
            },
            "Earth": {
                a: 1.000000, e: 0.016710, i: 0.0000,
                Omega: -11.260, omega: 114.207, M0: 357.517,
                period: 365.256,
                radius: 8, color: [100, 149, 237], 
                mass_earth: 1.0, gravity: 9.8, temp_avg: 15,
                day_hours: 24, moons: 1, atmosphere: true,
                fact: "The only known planet with life in the universe"
            },
            "Mars": {
                a: 1.523679, e: 0.093400, i: 1.8506,
                Omega: 49.558, omega: 286.503, M0: 19.373,
                period: 686.980,
                radius: 6, color: [205, 92, 92], 
                mass_earth: 0.107, gravity: 3.71, temp_avg: -65,
                day_hours: 24.6, moons: 2,
                fact: "Home to Olympus Mons, the largest volcano in the solar system"
            },
            "Jupiter": {
                a: 5.20260, e: 0.048498, i: 1.3033,
                Omega: 100.464, omega: 273.867, M0: 20.020,
                period: 4332.589,
                radius: 16, color: [218, 165, 32], 
                mass_earth: 317.8, gravity: 24.79, temp_avg: -110,
                day_hours: 9.9, moons: 95,
                fact: "The Great Red Spot is a storm larger than Earth that has raged for centuries"
            },
            "Saturn": {
                a: 9.55491, e: 0.055508, i: 2.4852,
                Omega: 113.665, omega: 339.392, M0: 317.020,
                period: 10759.22,
                radius: 14, color: [250, 235, 215], 
                mass_earth: 95.2, gravity: 10.44, temp_avg: -140,
                day_hours: 10.7, moons: 146, rings: true,
                fact: "Saturn's rings are made of ice and rock, some pieces as large as houses"
            },
            "Uranus": {
                a: 19.2184, e: 0.046295, i: 0.7730,
                Omega: 74.006, omega: 96.998, M0: 142.238,
                period: 30688.5,
                radius: 10, color: [64, 224, 208], 
                mass_earth: 14.5, gravity: 8.69, temp_avg: -195,
                day_hours: -17.2, moons: 28, rings: true,
                fact: "Tilted on its side at 98°, making it roll rather than spin"
            },
            "Neptune": {
                a: 30.1104, e: 0.008988, i: 1.7700,
                Omega: 131.784, omega: 272.846, M0: 256.228,
                period: 60182.0,
                radius: 10, color: [65, 105, 225], 
                mass_earth: 17.1, gravity: 11.15, temp_avg: -200,
                day_hours: 16.1, moons: 16,
                fact: "Has the fastest winds in the solar system at over 2100 km/h"
            }
        };

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let camera = {
            rotationX: -25,
            rotationZ: 0,
            distance: 2000,
            dragging: false,
            lastMouse: [0, 0]
        };
        
        let currentDate = new Date();
        let paused = false;
        let selectedPlanet = null;
        let zoom = 120;
        let trails = {};
        let showWelcome = true;
        let showControls = true;
        let showTrails = true;
        let viewMode = '3d';
        
        Object.keys(PLANETS).forEach(name => {
            trails[name] = [];
        });
        
        function daysSinceJ2000(date) {
            return (date - J2000_EPOCH) / (1000 * 60 * 60 * 24);
        }
        
        function meanAnomaly(elements, date) {
            const days = daysSinceJ2000(date);
            const n = 360.0 / elements.period;
            return (elements.M0 + n * days) % 360.0;
        }
        
        function solveKepler(M_deg, eccentricity) {
            let M = (M_deg * Math.PI / 180) % (2 * Math.PI);
            if (M > Math.PI) M -= 2 * Math.PI;
            
            let E = eccentricity < 0.8 ? M : Math.PI;
            
            for (let i = 0; i < 10; i++) {
                const f = E - eccentricity * Math.sin(E) - M;
                const fPrime = 1.0 - eccentricity * Math.cos(E);
                const correction = f / fPrime;
                E -= correction;
                
                if (Math.abs(correction) < 1e-10) break;
            }
            
            return E;
        }
        
        function trueAnomaly(E, eccentricity) {
            const halfE = E / 2.0;
            const sqrtRatio = Math.sqrt((1 + eccentricity) / (1 - eccentricity));
            return 2.0 * Math.atan2(sqrtRatio * Math.sin(halfE), Math.cos(halfE));
        }
        
        function elementsToXYZ(elements, date) {
            const a = elements.a;
            const e = elements.e;
            const i = elements.i * Math.PI / 180;
            const Omega = elements.Omega * Math.PI / 180;
            const omega = elements.omega * Math.PI / 180;
            
            const M = meanAnomaly(elements, date);
            const E = solveKepler(M, e);
            const nu = trueAnomaly(E, e);
            
            const r = a * (1 - e * Math.cos(E));
            const u = omega + nu;
            
            const cosU = Math.cos(u);
            const sinU = Math.sin(u);
            const cosOmega = Math.cos(Omega);
            const sinOmega = Math.sin(Omega);
            const cosI = Math.cos(i);
            const sinI = Math.sin(i);
            
            const x = r * (cosOmega * cosU - sinOmega * sinU * cosI);
            const y = r * (sinOmega * cosU + cosOmega * sinU * cosI);
            const z = r * (sinU * sinI);
            
            return [x, y, z];
        }
        
        function project3D(x, y, z) {
            if (viewMode === '2d') {
                const screenX = canvas.width / 2 + x * zoom;
                const screenY = canvas.height / 2 - y * zoom;
                return [screenX, screenY, z, 1];
            } else {
                const cosZ = Math.cos(camera.rotationZ * Math.PI / 180);
                const sinZ = Math.sin(camera.rotationZ * Math.PI / 180);
                const xRot = x * cosZ - y * sinZ;
                const yRot = x * sinZ + y * cosZ;
                
                const cosX = Math.cos(camera.rotationX * Math.PI / 180);
                const sinX = Math.sin(camera.rotationX * Math.PI / 180);
                const yFinal = yRot * cosX - z * sinX;
                const zFinal = yRot * sinX + z * cosX;
                
                const perspectiveScale = camera.distance / (camera.distance + zFinal * zoom);
                
                const screenX = canvas.width / 2 + xRot * zoom * perspectiveScale;
                const screenY = canvas.height / 2 - yFinal * zoom * perspectiveScale;
                
                return [screenX, screenY, zFinal, perspectiveScale];
            }
        }
        
        function drawStars() {
            const starCount = Math.min(500, canvas.width * canvas.height / 4000);
            
            for (let i = 0; i < starCount; i++) {
                const seedX = (i * 73 + Math.floor(camera.rotationZ / 5) * 127) % 9973;
                const seedY = (i * 97 + Math.floor(camera.rotationX / 5) * 151) % 9973;
                const seedB = (i * 61) % 9973;
                
                const x = (seedX / 9973) * canvas.width;
                const y = (seedY / 9973) * canvas.height;
                const brightness = 120 + (seedB % 135);
                const size = (seedB % 100) < 5 ? 2 : 1;
                
                if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                    ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                    ctx.fillRect(Math.floor(x), Math.floor(y), size, size);
                }
            }
        }
        
        function drawSun() {
            const [screenX, screenY, depth, scale] = project3D(0, 0, 0);
            let radius = Math.max(6, 20 * scale);
            
            if (viewMode === '2d') {
                radius = Math.max(8, Math.min(25, zoom / 8));
            }
            
            const gradient = ctx.createRadialGradient(screenX, screenY, 0, screenX, screenY, radius + 15);
            gradient.addColorStop(0, 'rgba(255, 215, 0, 0.9)');
            gradient.addColorStop(0.4, 'rgba(255, 180, 0, 0.5)');
            gradient.addColorStop(1, 'rgba(255, 140, 0, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(screenX, screenY, radius + 15, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = 'rgb(255, 215, 0)';
            ctx.beginPath();
            ctx.arc(screenX, screenY, radius, 0, 2 * Math.PI);
            ctx.fill();
        }
        
        function drawOrbit(name) {
            const elements = PLANETS[name];
            const points = [];
            
            for (let i = 0; i <= 180; i++) {
                const nu = 2 * Math.PI * i / 180;
                const r = elements.a * (1 - elements.e * elements.e) / (1 + elements.e * Math.cos(nu));
                
                const i_rad = elements.i * Math.PI / 180;
                const Omega_rad = elements.Omega * Math.PI / 180;
                const omega_rad = elements.omega * Math.PI / 180;
                const u = omega_rad + nu;
                
                const cosU = Math.cos(u);
                const sinU = Math.sin(u);
                const cosOmega = Math.cos(Omega_rad);
                const sinOmega = Math.sin(Omega_rad);
                const cosI = Math.cos(i_rad);
                const sinI = Math.sin(i_rad);
                
                const x = r * (cosOmega * cosU - sinOmega * sinU * cosI);
                const y = r * (sinOmega * cosU + cosOmega * sinU * cosI);
                const z = r * (sinU * sinI);
                
                const [screenX, screenY] = project3D(x, y, z);
                if (screenX > -200 && screenX < canvas.width + 200 && 
                    screenY > -200 && screenY < canvas.height + 200) {
                    points.push([screenX, screenY]);
                }
            }
            
            if (points.length > 2) {
                ctx.strokeStyle = name === selectedPlanet ? 
                    'rgba(160, 160, 255, 0.8)' : 'rgba(100, 100, 140, 0.4)';
                ctx.lineWidth = name === selectedPlanet ? 2 : 1;
                ctx.beginPath();
                ctx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i][0], points[i][1]);
                }
                ctx.stroke();
            }
        }
        
        function calculateLabelPosition(screenX, screenY, radius, usedPositions) {
            const positions = [
                [screenX + radius + 8, screenY - radius/2],
                [screenX + radius + 8, screenY + radius + 15],
                [screenX - radius - 60, screenY - radius/2],
                [screenX - radius - 60, screenY + radius + 15],
                [screenX, screenY - radius - 20],
                [screenX, screenY + radius + 25]
            ];
            
            for (const [x, y] of positions) {
                let collision = false;
                for (const used of usedPositions) {
                    if (Math.abs(x - used.x) < 70 && Math.abs(y - used.y) < 20) {
                        collision = true;
                        break;
                    }
                }
                if (!collision) {
                    return { x, y };
                }
            }
            
            return { x: positions[0][0], y: positions[0][1] };
        }
        
        function drawPlanet(name, position) {
            const [x, y, z] = position;
            const [screenX, screenY, depth, scale] = project3D(x, y, z);
            
            if (scale <= 0 || screenX < -300 || screenX > canvas.width + 300 || 
                screenY < -300 || screenY > canvas.height + 300) {
                return null;
            }
            
            const planet = PLANETS[name];
            let radius = Math.max(3, planet.radius * scale);
            
            if (viewMode === '2d') {
                radius = Math.max(4, Math.min(planet.radius * 1.5, zoom / 12));
            }
            
            const [r, g, b] = planet.color;
            const isObscured = viewMode === '3d' && depth > 0 && scale < 0.2;
            
            if (isObscured) {
                ctx.globalAlpha = 0.3;
            }
            
            if (name === selectedPlanet && !isObscured) {
                ctx.strokeStyle = 'rgba(160, 160, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(screenX, screenY, radius + 6, 0, 2 * Math.PI);
                ctx.stroke();
            }
            
            if (planet.atmosphere && !isObscured) {
                const atmoRadius = radius + 3;
                const atmoGradient = ctx.createRadialGradient(
                    screenX, screenY, radius,
                    screenX, screenY, atmoRadius
                );
                atmoGradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.1)`);
                atmoGradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.03)`);
                ctx.fillStyle = atmoGradient;
                ctx.beginPath();
                ctx.arc(screenX, screenY, atmoRadius, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.beginPath();
            ctx.arc(screenX, screenY, radius, 0, 2 * Math.PI);
            ctx.fill();
            
            if (!isObscured) {
                const highlightR = Math.min(255, r + 40);
                const highlightG = Math.min(255, g + 40);
                const highlightB = Math.min(255, b + 40);
                const highlightRadius = Math.max(1, radius / 4);
                
                ctx.fillStyle = `rgba(${highlightR}, ${highlightG}, ${highlightB}, 0.6)`;
                ctx.beginPath();
                ctx.arc(screenX - radius/4, screenY - radius/4, highlightRadius, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            if (planet.rings && radius > 4) {
                const ringWidth = (radius + 8) * 2;
                let ringHeight = viewMode === '2d' ? 6 : Math.abs(4 * Math.cos(camera.rotationX * Math.PI / 180));
                
                if (ringHeight > 1) {
                    ctx.strokeStyle = name === 'Saturn' ? 
                        'rgba(210, 180, 140, 0.7)' : 'rgba(120, 160, 200, 0.6)';
                    ctx.lineWidth = Math.max(1, scale * 1.5);
                    
                    for (let i = 0; i < 2; i++) {
                        const layerWidth = ringWidth + i * 3;
                        const layerHeight = ringHeight + i * 1;
                        ctx.beginPath();
                        ctx.ellipse(screenX, screenY, layerWidth/2, layerHeight/2, 0, 0, 2 * Math.PI);
                        ctx.stroke();
                    }
                }
            }
            
            if (showTrails && !isObscured) {
                trails[name].push([x, y, z, Date.now()]);
                if (trails[name].length > 120) {
                    trails[name].shift();
                }
                
                if (trails[name].length > 2) {
                    for (let i = 1; i < trails[name].length; i++) {
                        const [tx, ty, tz] = trails[name][i];
                        const [tScreenX, tScreenY, tDepth, tScale] = project3D(tx, ty, tz);
                        
                        const alpha = (i / trails[name].length) * 0.4;
                        const trailSize = Math.max(1, 2 * tScale);
                        
                        ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                        ctx.beginPath();
                        ctx.arc(tScreenX, tScreenY, trailSize, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
            }
            
            ctx.globalAlpha = 1.0;
            
            return { name, screenX, screenY, radius, scale, isObscured };
        }
        
        function drawLabels(planetData) {
            const usedPositions = [];
            
            planetData.sort((a, b) => {
                if (a.name === selectedPlanet) return -1;
                if (b.name === selectedPlanet) return 1;
                if (a.isObscured !== b.isObscured) return a.isObscured ? 1 : -1;
                return b.scale - a.scale;
            });
            
            planetData.forEach(planet => {
                if (planet.scale > 0.1 && !planet.isObscured) {
                    const fontSize = Math.max(10, Math.min(14, 12 * planet.scale));
                    ctx.font = `${fontSize}px 'Segoe UI', sans-serif`;
                    
                    const labelPos = calculateLabelPosition(
                        planet.screenX, planet.screenY, planet.radius, usedPositions
                    );
                    
                    const textWidth = ctx.measureText(planet.name).width;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(labelPos.x - 2, labelPos.y - fontSize, textWidth + 4, fontSize + 2);
                    
                    ctx.fillStyle = 'white';
                    ctx.fillText(planet.name, labelPos.x, labelPos.y);
                    
                    usedPositions.push({ x: labelPos.x, y: labelPos.y });
                }
            });
        }
        
        function handleMouseDown(e) {
            camera.dragging = true;
            camera.lastMouse = [e.clientX, e.clientY];
            canvas.style.cursor = 'grabbing';
        }
        
        function handleMouseUp() {
            camera.dragging = false;
            canvas.style.cursor = 'grab';
        }
        
        function handleMouseMove(e) {
            if (camera.dragging && viewMode === '3d') {
                const dx = e.clientX - camera.lastMouse[0];
                const dy = e.clientY - camera.lastMouse[1];
                
                camera.rotationZ += dx * 0.5;
                camera.rotationX = Math.max(-89, Math.min(89, camera.rotationX + dy * 0.3));
                
                camera.lastMouse = [e.clientX, e.clientY];
            }
        }
        
        function handleWheel(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
            
            if (viewMode === '2d') {
                zoom = Math.max(10, Math.min(1000, zoom * zoomFactor));
            } else {
                camera.distance = Math.max(100, Math.min(20000, camera.distance * zoomFactor));
            }
        }
        
        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            let clickedPlanet = null;
            let minDistance = Infinity;
            
            Object.entries(PLANETS).forEach(([name, elements]) => {
                const position = elementsToXYZ(elements, currentDate);
                const [screenX, screenY] = project3D(...position);
                
                const planet = PLANETS[name];
                let radius = Math.max(3, planet.radius);
                if (viewMode === '2d') {
                    radius = Math.max(4, Math.min(planet.radius * 1.5, zoom / 12));
                }
                
                const distance = Math.sqrt((x - screenX) ** 2 + (y - screenY) ** 2);
                
                if (distance < radius + 12 && distance < minDistance) {
                    minDistance = distance;
                    clickedPlanet = name;
                }
            });
            
            if (clickedPlanet) {
                selectPlanet(clickedPlanet);
            }
        }
        
        function handleKeyPress(e) {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'r':
                case 'R':
                    resetCamera();
                    break;
                case 'h':
                case 'H':
                    toggleHelp();
                    break;
                case 'v':
                case 'V':
                    toggleViewMode();
                    break;
                case '1': selectPlanet('Mercury'); break;
                case '2': selectPlanet('Venus'); break;
                case '3': selectPlanet('Earth'); break;
                case '4': selectPlanet('Mars'); break;
                case '5': selectPlanet('Jupiter'); break;
                case '6': selectPlanet('Saturn'); break;
                case '7': selectPlanet('Uranus'); break;
                case '8': selectPlanet('Neptune'); break;
            }
        }
        
        function hideWelcome() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('viewMode').style.display = 'block';
            showWelcome = false;
            document.getElementById('loading').style.display = 'none';
        }
        
        function togglePause() {
            paused = !paused;
            const statusEl = document.getElementById('status');
            const pauseBtnEl = document.getElementById('pauseBtn');
            
            if (paused) {
                statusEl.textContent = 'PAUSED';
                statusEl.className = 'status paused';
                pauseBtnEl.textContent = 'Resume';
            } else {
                statusEl.textContent = 'RUNNING';
                statusEl.className = 'status running';
                pauseBtnEl.textContent = 'Pause';
            }
        }
        
        function timeStep(days) {
            currentDate.setTime(currentDate.getTime() + days * 24 * 60 * 60 * 1000);
        }
        
        function resetToToday() {
            currentDate = new Date();
        }
        
        function resetCamera() {
            if (viewMode === '3d') {
                camera.rotationX = -25;
                camera.rotationZ = 0;
                camera.distance = 2000;
                zoom = 120;
            } else {
                zoom = 80;
            }
        }
        
        function toggleViewMode() {
            viewMode = viewMode === '3d' ? '2d' : '3d';
            
            const btn = document.getElementById('viewModeBtn');
            const indicator = document.getElementById('viewMode');
            
            if (viewMode === '2d') {
                camera.rotationX = -90;
                camera.rotationZ = 0;
                zoom = 80;
                btn.textContent = 'Switch to 3D';
                btn.classList.add('active');
                indicator.textContent = '2D Map View';
            } else {
                camera.rotationX = -25;
                camera.rotationZ = 0;
                camera.distance = 2000;
                zoom = 120;
                btn.textContent = 'Switch to 2D Map';
                btn.classList.remove('active');
                indicator.textContent = '3D Perspective View';
            }
        }
        
        function toggleTrails() {
            showTrails = !showTrails;
            const btn = document.getElementById('trailsBtn');
            
            if (showTrails) {
                btn.textContent = 'Hide Trails';
                btn.classList.remove('active');
            } else {
                btn.textContent = 'Show Trails';
                btn.classList.add('active');
                Object.keys(trails).forEach(name => {
                    trails[name] = [];
                });
            }
        }
        
        function setZoomPreset(preset) {
            if (viewMode === '2d') {
                switch(preset) {
                    case 'close': zoom = 400; break;
                    case 'inner': zoom = 200; break;
                    case 'outer': zoom = 80; break;
                    case 'system': zoom = 30; break;
                }
            } else {
                switch(preset) {
                    case 'close': camera.distance = 200; break;
                    case 'inner': camera.distance = 600; break;
                    case 'outer': camera.distance = 2000; break;
                    case 'system': camera.distance = 8000; break;
                }
            }
        }
        
        function toggleHelp() {
            showControls = !showControls;
            document.getElementById('controls').style.display = showControls ? 'block' : 'none';
        }
        
        function selectPlanet(name) {
            selectedPlanet = selectedPlanet === name ? null : name;
            
            document.querySelectorAll('.planet-btn').forEach(btn => {
                if (btn.dataset.planet === selectedPlanet) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            const infoPanel = document.getElementById('planetInfo');
            if (selectedPlanet) {
                const planet = PLANETS[selectedPlanet];
                const position = elementsToXYZ(planet, currentDate);
                const distance = Math.sqrt(position[0]**2 + position[1]**2 + position[2]**2);
                
                const earthPos = elementsToXYZ(PLANETS.Earth, currentDate);
                const earthDistance = Math.sqrt(
                    (position[0] - earthPos[0])**2 + 
                    (position[1] - earthPos[1])**2 + 
                    (position[2] - earthPos[2])**2
                );
                
                const orbitalSpeed = Math.sqrt(1.0 / distance) * 29.78;
                
                document.getElementById('planetDetails').innerHTML = `
                    <div class="planet-name">${selectedPlanet.toUpperCase()}</div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="accent">Distance from Sun</div>
                            <div>${distance.toFixed(3)} AU</div>
                            <div>${(distance * 149.6).toFixed(1)} million km</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Distance from Earth</div>
                            <div>${earthDistance.toFixed(3)} AU</div>
                            <div>${(earthDistance * 149.6).toFixed(1)} million km</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Orbital Speed</div>
                            <div>${orbitalSpeed.toFixed(1)} km/s</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Orbital Period</div>
                            <div>${planet.period.toFixed(0)} days</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Mass</div>
                            <div>${planet.mass_earth.toFixed(2)} Earth masses</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Gravity</div>
                            <div>${planet.gravity.toFixed(1)} m/s²</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Day Length</div>
                            <div>${Math.abs(planet.day_hours).toFixed(1)} hours${planet.day_hours < 0 ? ' (retrograde)' : ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="accent">Moons</div>
                            <div>${planet.moons}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding: 10px; background: rgba(60, 60, 80, 0.4); border-radius: 4px;">
                        <div class="accent" style="margin-bottom: 6px;">Fact</div>
                        <div style="font-size: 11px; line-height: 1.4;">${planet.fact}</div>
                    </div>
                `;
                infoPanel.style.display = 'block';
            } else {
                infoPanel.style.display = 'none';
            }
        }
        
        function updateHUD() {
            const options = { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', timeZone: 'UTC'
            };
            
            document.getElementById('dateDisplay').innerHTML = 
                `Date: ${currentDate.toLocaleDateString('en-US', options)} UTC`;
            
            document.getElementById('cameraInfo').innerHTML = 
                `Camera: ${camera.rotationX.toFixed(0)}° tilt, ${camera.rotationZ.toFixed(0)}° rotation`;
            
            if (viewMode === '2d') {
                document.getElementById('zoomInfo').innerHTML = 
                    `Zoom: ${zoom.toFixed(0)}x`;
            } else {
                document.getElementById('zoomInfo').innerHTML = 
                    `Distance: ${(camera.distance / 100).toFixed(1)} AU`;
            }
            
            if (selectedPlanet) {
                const position = elementsToXYZ(PLANETS[selectedPlanet], currentDate);
                const distance = Math.sqrt(position[0]**2 + position[1]**2 + position[2]**2);
                document.getElementById('selectedInfo').innerHTML = 
                    `<div class="highlight">Selected: ${selectedPlanet} (${distance.toFixed(2)} AU)</div>`;
            } else {
                document.getElementById('selectedInfo').innerHTML = '';
            }
        }
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        function render() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0c0c0c');
            gradient.addColorStop(0.5, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawStars();
            
            Object.keys(PLANETS).forEach(name => {
                drawOrbit(name);
            });
            
            const planetData = [];
            Object.entries(PLANETS).forEach(([name, elements]) => {
                const position = elementsToXYZ(elements, currentDate);
                const [, , depth] = project3D(...position);
                planetData.push([name, position, depth]);
            });
            
            if (viewMode === '3d') {
                planetData.sort((a, b) => b[2] - a[2]);
            } else {
                planetData.sort((a, b) => {
                    const distA = Math.sqrt(a[1][0]**2 + a[1][1]**2);
                    const distB = Math.sqrt(b[1][0]**2 + b[1][1]**2);
                    return distA - distB;
                });
            }
            
            drawSun();
            
            const labelData = [];
            planetData.forEach(([name, position]) => {
                const result = drawPlanet(name, position);
                if (result) labelData.push(result);
            });
            
            drawLabels(labelData);
            
            if (!showWelcome) {
                updateHUD();
            }
            
            if (!paused && !showWelcome) {
                currentDate.setTime(currentDate.getTime() + 2 * 60 * 60 * 1000);
            }
            
            requestAnimationFrame(render);
        }
    
        function init() {
            resizeCanvas();
            
            canvas.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('click', handleClick);
            window.addEventListener('keypress', handleKeyPress);
            window.addEventListener('resize', resizeCanvas);
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('welcome').style.display = 'block';
            }, 800);
            
            render();
        }
        
        init();
    </script>
</body>
</html>